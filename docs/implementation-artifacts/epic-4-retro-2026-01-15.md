# Epic 4 复盘（Retrospective）

- 项目：Prompt Faster
- Epic：4（自动迭代优化执行）
- 日期：2026-01-15
- 复盘主持：Bob（Scrum Master）
- 参会：耶稣（Project Lead）、Alice（Product Owner）、Charlie（Senior Dev）、Dana（QA Engineer）、Winston（Architect）、Amelia（Dev Agent）

## 1) Epic 概览

- 完成度：8/8 stories（`docs/implementation-artifacts/sprint-status.yaml`）
- 核心交付：Layer 1–4 + 执行模式/并行调度 + 失败档案/多样性注入 + 扩展模板与工程化文档 + 核心算法模块替换演练（Default ↔ Alternate）
- 关键上下文缺口：缺少 Epic 3 的复盘文件（仓库仅见 Epic 1/2 的 retro），因此本次无法做“上一轮行动项兑现率”的连续性对照。

## 2) 做得好的地方（What went well）

1. **确定性/可复现作为硬约束被贯彻**
   - 8/8 stories 明确强调“纯内存、确定性、不出网”的测试与验证路径。
   - 对后续 Epic 5（实时 UI/可视化）非常关键：可视化开发可先用确定性数据源闭环，不被真实上游波动拖慢。

2. **“同序契约”被持续写死（防错位）**
   - 在执行、评估、并发调度中反复强调“结果与输入稳定对齐”，避免 `zip(batch, exec_results, eval_results)` 级联错位。
   - 该契约是后续节点图/数据流动画的基础（否则 UI 会出现“看起来在跑、实际对不上号”）。

3. **证据链（测试/门禁/可复现命令）逐步成为默认文化**
   - 多个故事体现了“Story 勾选 vs 代码证据”不一致会被 review 指出，并通过补单测/补命令序列收敛。
   - Story 4.5 有独立基准报告（调度开销与串并行差异对比）。
   - Story 4.8 把“算法可替换（NFR15）”落成可证伪演练：`alt-optimization-engine` feature + CI 双路径（含 clippy/test）。

4. **脱敏约束被提升为一等公民**
   - 多处明确“错误/日志/测试输出不得包含 prompt/testcase 原文或敏感 token”，并对摘要链路做了结构化收敛（避免泄露通道）。

## 3) 遇到的挑战（What didn’t / friction）

1. **证据链补齐往往出现在收尾阶段**
   - 现象：临近完成时才发现“已完成声明缺证据/测试缺口/命令不可复现”，导致返工成本上升。
   - 本质：DoD 的“证据链门禁”还需要更早、更硬地介入（而不是只在 review 阶段被动发现）。

2. **契约存在分散风险（重复对齐成本）**
   - 典型包括：Trait shape、`ctx.extensions` 注入 key、同序要求、脱敏边界、以及（为 Epic 5）WS 事件形状/状态枚举。
   - 风险：契约分散时，团队会反复对齐、并且更容易在迭代中漂移。

3. **部分能力以“骨架/延期”存在（对后续端到端验证有影响）**
   - 示例：真实 Dify/Direct 执行仍可能保留骨架/NotImplemented 路径；ReflectionResult 生成/串联闭环仍需后续完善。
   - 结论：这不是失败，而是范围控制；但需要在 Epic 5 的验证策略中明确“哪些用 mock 闭环、哪些必须接真实链路”。

## 4) 关键洞察（Key insights）

- **工程纪律本身就是产品能力**：确定性、同序契约、脱敏、单一工厂入口点（避免选择逻辑散落）应被当作“不可妥协的系统不变量”。
- **把契约集中化，能显著降低后续可视化开发的返工概率**：尤其是 WS 事件 schema 与状态/阶段映射，如果不先冻结，前端会被迫猜逻辑。
- **缺少 Epic 3 retro 是组织记忆的断点**：后续即便 retro 标记为 optional，也建议形成“能被检索/能被追踪”的最小复盘产物。

## 5) 行动项（Action items）

> 规则：不写工期预估；全部以“验收标准 + 触发门禁 + 所属 Owner”表达。

### A. 流程改进（Process）

1. **把“证据链 DoD”前移为门禁**
   - Owner：Charlie（Senior Dev）+ Dana（QA Engineer）
   - 成功标准：
     - 任何 Story 标记为 `done` 前，必须满足：最小单测覆盖 + 可复现命令序列 + 关键安全/脱敏断言（如哨兵串不泄露）。
     - review 中出现“已完成但无证据”的情况显著下降（用 review notes 作为证据来源）。

2. **建立“契约单一权威”清单**
   - Owner：Winston（Architect）+ Amelia（Dev Agent）
   - 成功标准：
     - `ctx.extensions` key、同序契约、脱敏边界、（后续）WS 事件字段与状态枚举，都有一个可检索的权威入口（文档或类型定义）。
     - 新增/变更契约必须同步更新该入口，并有对应测试或校验。

3. **补齐 Epic 3 复盘（形成连续性）**
   - Owner：耶稣（Project Lead）
   - 成功标准：补一份最小复盘文档（行动项 + 风险 + 下一步），让 Epic 4/5 的复盘能做连续性对照。

### B. 技术债/遗留（Technical debt / carry-overs）

> 只列对 Epic 5 风险较高或会影响后续扩展的条目；其余延后按优先级拆分。

1. **WS/可视化链路的脱敏回归门禁**
   - Owner：Dana（QA Engineer）
   - 成功标准：对 WS payload 与前端展示新增回归断言：不得出现 prompt/testcase 原文或敏感 token；仅允许结构化摘要/长度/hash/必要截断（且必须经过脱敏规则）。

2. **真实执行链路（Dify/Direct）完善与错误映射**
   - Owner：Amelia（Dev Agent）
   - 成功标准：NotImplemented 骨架被替换为可诊断、可回归的真实调用与错误分类；并保持同序契约与脱敏边界不被破坏。

3. **降低 Default/Alternate 引擎重复度，避免 drift**
   - Owner：Winston（Architect）+ Charlie（Senior Dev）
   - 成功标准：两条实现共享尽可能多的公共逻辑，同时仍保留“可证伪差异”；CI 继续覆盖 Default 与 `--features alt-optimization-engine` 双路径。

## 6) Epic 5（可视化与实时反馈）开工前 P0 准备清单（已达成共识）

1. 冻结后端→前端 WS 事件契约（schema + 必带字段含 `correlationId`），并作为单一权威  
2. 状态/阶段口径由后端提供，前端只映射，不推断  
3. 提供“纯本地、确定性、不出网”的可视化 demo 数据源闭环（可验证不串台/不乱序）  
4. 脱敏边界升级为门禁（WS/UI/错误字符串均不泄露）  
5. 性能验证口径预置（NFR2/NFR3），形成可回归对比

## 7) 结语与承诺

- 我们认可：Epic 4 的核心价值不止是功能完成，更是把“可复现、可验证、可替换、可安全展示”的工程纪律落成了长期资产。
- 我们承诺：在进入 Epic 5 的实时可视化之前，先把契约与门禁钉牢，减少后续返工与风险。

