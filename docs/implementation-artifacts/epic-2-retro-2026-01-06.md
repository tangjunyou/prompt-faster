# Epic 2 复盘（Retrospective）

- 项目：Prompt Faster（prompt-faster）
- Epic：Epic 2「测试集管理」
- 日期：2026-01-06
- 复盘方式：无责复盘（聚焦系统/流程/学习）

## 参与角色（Party Mode）

- Bob (Scrum Master)
- Alice (Product Owner)
- Winston (Architect)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- 耶稣 (Project Lead)

## Epic 2 概览（基于 `docs/implementation-artifacts/sprint-status.yaml`）

- 完成情况：6/6 stories 已标记 `done`（2.1 ~ 2.6）
- Retro 状态：本文件用于标记 Epic 2 复盘完成
- 下一 Epic：Epic 3「优化任务配置与工作区」（存在，见 `docs/project-planning-artifacts/epics.md`）

## 做得好的（Successes）

1) **“可用链路（B）”端到端闭环**
   - 测试集 CRUD（2.1）
   - JSONL(txt) 批量导入（2.2）：逐行解析、行号定位、失败不误写
   - 测试集模板保存与复用（2.3）：workspace 隔离、深拷贝语义清晰
   - Dify 变量解析与目标变量指定（2.4）
   - 通用 API 自定义变量 + 固定任务标准答案（2.5）
   - 创意任务核心诉求 + 结构化约束（2.6）

2) **“护栏与合约（A）”贯穿实现并降低返工**
   - `cases` 作为单一事实来源：UI 编辑全部写回 `casesJson`，与 JSON 编辑/导入视图保持一致
   - list 接口仅返回 summary，详情按需拉取，避免大字段误入列表
   - 权限边界：跨用户/跨 workspace 一律 404，不泄露资源存在性
   - 类型生成链路持续对齐：OpenAPI + `gen-types` 驱动前后端一致

3) **质量门禁成为常态**
   - 后端：`cargo test`（含集成测试）
   - 前端：`npm test -- --run`（含关键交互测试）

## 挑战与痛点（Challenges）

1) **“复制/原子性/一致性”是重复出现的复杂点**
   - 模板复制不仅复制 `cases`，还要复制 Dify/通用变量配置；一旦出现“创建后补写”，就会引入偶发丢配置的风险。

2) **边界语义与鲁棒性容易被忽略**
   - 404 错误码语义在不同 endpoint 上若不统一，会导致客户端难以判断“workspace 问题 vs test_set 问题”
   - Dify 配置存在“变量快照一致性校验、base_url 规范化、缓存大小控制”等边界需求，若不处理会在后续 Epic 被放大

## 关键洞察（Key Insights）

1) **A 是 B 的稳定底座，B 是 A 的真实性验收**
   - 对外：用“可用链路”衡量价值
   - 对内：用“护栏与合约”作为不可妥协的质量门槛

2) **数据密集链路的“用户可修复性”比“报错本身”更重要**
   - JSONL 导入的行号定位 + 失败不误写，是可持续体验的关键

## Epic 2 遗留项关单（本次复盘期间已完成）

> 目标：做到最好，但不做过度设计；把 Epic 2 明确标注的遗留项正确关单，并用测试锁死。

1) **统一 404 错误码语义（workspace → WORKSPACE_NOT_FOUND）**
   - 统一在 `test_sets` 子资源（get/update/delete、dify/generic 配置、refresh）入口先校验 workspace 归属
   - 影响：跨用户访问同一 workspace_id 时，错误码从 `TEST_SET_NOT_FOUND` 统一为 `WORKSPACE_NOT_FOUND`（仍然是 404）

2) **Dify 配置边界加固**
   - base_url 规范化：改用 URL 解析，仅在 path==`/v1` 时移除，避免误删路径
   - variables 快照一致性：当存在 `parametersSnapshot` 时，校验 `targetPromptVariable` 与 `bindings` 必须出现在快照变量名集合中
   - parametersSnapshot 缓存大小：超过阈值则跳过缓存，避免 DB 膨胀（不影响本次 refresh 返回）
   - raw debug 片段：修正为使用真实 component key

3) **回归验证**
   - 后端测试全量通过（含 test_sets / dify / generic / templates 相关集成测试）
   - 前端测试全量通过（含 TestSetsView 交互测试）

## Epic 3（优化任务配置与工作区）准备讨论（Preparation）

### 依赖关系（Epic 3 对 Epic 2 的依赖）

- Epic 3 的任务创建/配置将强依赖：
  - 可选择/关联测试集（来自 Epic 2 的 CRUD + list summary + 权限隔离）
  - 任务模式（固定/创意）与 `TaskReference` 的统一抽象（2.5/2.6 已铺好数据结构）
  - 执行目标配置（Dify/通用 API）作为后续“任务级配置”的输入来源

### 准备项（不引入过度设计的前提下）

**Critical（开始 Epic 3 前必须满足）**

1) 确认 Epic 2 遗留项已关单并被测试覆盖（本次复盘已完成）
2) 为 Epic 3 生成可开发的 story 文档（由 SM 逐个 create-story 产出到 `docs/implementation-artifacts/`）

**Parallel（可与 Epic 3 早期 story 并行）**

- 补齐“任务执行引擎”所需的最小合约清单（哪些配置在任务级、哪些在测试集级；避免职责漂移）

## Significant Discovery（是否需要更新 Epic 3 计划？）

- 结论：**不需要对 Epic 3 功能范围做根本性调整**
- 需要保持的约束：继续坚持“单一事实来源 + 原子写入 + 合约/类型生成对齐 + 测试门禁”，否则 Epic 3 的配置/工作区会放大一致性风险

## 就绪性核对（Readiness Check）

- Testing & Quality：充分（本次复盘期间已补齐并验证关键回归）
- Codebase Health：良好（边界语义与 Dify 配置鲁棒性已加固）
- Unresolved Blockers：无明确硬阻塞
- 决策：允许进入 Epic 3（按 story 逐步推进，继续执行门禁与护栏）

## 行动项（Action Items）

> 原则：具体、可验收、带 Owner；避免口号。

1) 将 Epic 3 的 3-1 ~ 3-7 逐个生成可开发 story 文档（AC/任务拆分/测试门禁）  
   - Owner：Bob (Scrum Master)  
   - Confirm：耶稣 (Project Lead)

2) 在 Epic 3 的任务配置设计中明确“测试集配置 vs 任务配置”的边界清单（避免把执行目标语义塞回测试集编辑）  
   - Owner：Winston (Architect) + Alice (Product Owner)  
   - Review：Charlie (Senior Dev)

## 结语（Closure）

Bob (Scrum Master): “Epic 2 的价值交付（B）与质量护栏（A）都做到了，并且把明确遗留项正确关单。下一步进入 Epic 3 时，我们保持同一套护栏与门禁，避免一致性问题在更复杂的配置/工作区场景里被放大。”

